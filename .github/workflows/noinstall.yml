# Initial example courtesy https://dev.to/mihinduranasinghe/using-docker-containers-in-jobs-github-actions-3eof

name: noinstall

# Run this workflow manually from the Actions tab
on: workflow_dispatch


jobs:
  containerized:
    runs-on: ubuntu-latest
    env:
       TMPTMPDIR: /tmp
    container: 
       image: gnuradio/ci:ubuntu-20.04-3.9
       env:
         TMPTMPDIR: /tmp
       
    # Steps represent a sequence of tasks that will be executed as part of the job
    name: Containerized execution
    steps:     
      - name: Make a place to store logs
        run: |
          mkdir -p ~/artifacts
          touch ~/artifacts/IAMImage.id

      - name: Checkout the current branch
        uses: actions/checkout@master

      - name: Install dependencies as needed
        run: |
          sudo apt install -qy build-essential cmake cmake-curses-gui ninja-build python3-pip
          sudo apt install -qy texinfo gawk python3-pip swig
          sudo apt install -qy libqwt-qt5-dev libqt5opengl5-dev python3-pyqt5 
          sudo apt install -qy python3-gi python3-gi-cairo gir1.2-gtk-3.0 
          sudo apt install -qy gnuradio gnuradio-dev
          sudo apt install -qy npm
          sudo npm install -g npm@8.5 node@14
          sudo npm install -g bokeh @bokeh/bokehjs
          pip3 install bokeh
          exit

      - name: Sanity checks
        run: |
          gr_modtool info | tee ~/artifacts/sanity.logs
          bokeh info | tee -a ~/artifacts/sanity.logs
          cd ${TMPTMPDIR}
          wget https://github.com/bokeh/bokeh/archive/refs/tags/$(bokeh --version).tar.gz      
          tar -xvf $(bokeh --version).tar.gz bokeh-$(bokeh --version)/examples/app --strip-components=2
          cp -r app/spectrogram ~/artifacts          

      - name: Upload artifacts from container?
        uses: actions/upload-artifact@v2
        with:
          name: container artifacts
          path: ~/artifacts/

  hosted:
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    name: Hosted execution
    steps:     
    - name: Make a place to store logs
      run: |
        mkdir -p ~/artifacts
        touch ~/artifacts/IAMHost.id
        
    - name: Upload artifacts from host 
      uses: actions/upload-artifact@v2
      with:
        name: host artifacts
        path: ~/artifacts/
